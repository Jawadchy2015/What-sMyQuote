<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quote Builder • WhatsMyQuote</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind Config for nice fonts & container
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["Inter", "ui-sans-serif", "system-ui", "-apple-system", "Segoe UI", "Roboto", "Ubuntu", "Cantarell", "Noto Sans", "Helvetica Neue", "Arial", "sans-serif"],
          },
          boxShadow: {
            soft: "0 10px 20px -8px rgba(0,0,0,0.25)",
          },
        },
      },
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    /* Smooth slide transitions */
    .slide-enter { opacity: 0; transform: translateX(20px); }
    .slide-enter-active { opacity: 1; transform: translateX(0); transition: all .25s ease; }
    .slide-exit { opacity: 1; transform: translateX(0); }
    .slide-exit-active { opacity: 0; transform: translateX(-20px); transition: all .2s ease; }
    /* Hide native number input arrows */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    /* Card focus ring */
    .select-card[aria-checked="true"] { outline: 2px solid rgb(34 197 94); outline-offset: 2px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen">
  <div class="max-w-7xl mx-auto min-h-screen px-4 md:px-6 lg:px-8 py-6 flex flex-col">
    <!-- Header -->
    <header class="flex items-start md:items-center justify-between gap-4">
	  <div class="hidden md:flex items-center gap-3">
		<a href="dashboard.html">
        	<button id="resetForm" class="px-3 py-2 text-sm rounded-lg border border-slate-200 hover:bg-slate-100">Back</button>
		</a>
        
      </div>
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold tracking-tight text-center">Quote Builder</h1>
        <p class="text-slate-500">Slide through, capture requirements, then save & send the quote.</p>
      </div>
      <div class="hidden md:flex items-center gap-3">
        <button id="resetForm" class="px-3 py-2 text-sm rounded-lg border border-slate-200 hover:bg-slate-100">Reset</button>
        <button id="loadDraft" class="px-3 py-2 text-sm rounded-lg border border-slate-200 hover:bg-slate-100">Load Draft</button>
      </div>
    </header>

    <!-- Progress -->
    <div class="mt-6">
      <ol id="progress" class="grid grid-cols-6 gap-3">
        <!-- JS will populate steps -->
      </ol>
    </div>

    <!-- Main Grid: Carousel (left) + Summary (right) -->
    <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1">
      <!-- Carousel Container -->
      <section class="lg:col-span-2 bg-white rounded-2xl shadow-soft p-4 md:p-6 flex flex-col min-h-[70vh]">
        <div id="slides" class="relative flex-1">
          <!-- Slides injected via JS to keep this file tidy -->
        </div>

        <!-- Footer Nav -->
        <div class="mt-6 flex items-center justify-between gap-3">
          <button id="prevBtn" class="px-4 py-2.5 rounded-xl border border-slate-200 hover:bg-slate-100 disabled:opacity-40 disabled:cursor-not-allowed">◀ Back</button>
          <div class="flex items-center gap-3">
            <button id="saveDraft" class="px-4 py-2.5 rounded-xl border border-slate-200 hover:bg-slate-100">Save Draft</button>
            <button id="nextBtn" class="px-5 py-2.5 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white shadow-2xl">Next ▶</button>
          </div>
        </div>
      </section>

      <!-- Live Summary -->
      <aside class="bg-white rounded-2xl shadow-2xl p-4 md:p-6 h-full sticky top-4">
        <h2 class="text-lg font-semibold">Quote Summary</h2>
        <p class="text-sm text-slate-500">Auto-updates as you move through steps.</p>

        <div class="mt-4 space-y-4 text-sm">
          <div>
            <h3 class="font-medium">Customer</h3>
            <div id="sum-customer" class="text-slate-600">—</div>
          </div>
          <div>
            <h3 class="font-medium">Devices</h3>
            <ul id="sum-devices" class="text-slate-600 list-disc pl-5 space-y-1">
              <li class="text-slate-400">No devices selected</li>
            </ul>
          </div>
          <div>
            <h3 class="font-medium">Plan</h3>
            <div id="sum-plan" class="text-slate-600">—</div>
          </div>
          <div>
            <h3 class="font-medium">Trade-In</h3>
            <div id="sum-trade" class="text-slate-600">—</div>
          </div>
          <div>
            <h3 class="font-medium">Add‑Ons</h3>
            <ul id="sum-addons" class="text-slate-600 list-disc pl-5 space-y-1">
              <li class="text-slate-400">No add-ons selected</li>
            </ul>
          </div>
        </div>

        <div class="mt-6 border-t pt-4">
          <h3 class="font-semibold">Estimated Total</h3>
          <div id="sum-total" class="text-2xl font-bold">—</div>
          <p id="sum-breakdown" class="text-xs text-slate-500 mt-1">Calculated on the Review step.</p>
        </div>
      </aside>
    </div>
  </div>

  <!-- SUCCESS TOAST -->
  <div id="toast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-emerald-600 text-white px-4 py-2.5 rounded-xl shadow-2xl">Saved!</div>

  <!-- SEND MODAL -->
  <div id="sendModal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/40 p-4">
    <div class="bg-white w-full max-w-lg rounded-2xl shadow-soft p-6">
      <div class="flex items-start justify-between">
        <h3 class="text-lg font-semibold">Send Quote to Customer</h3>
        <button class="p-2 -m-2 text-slate-500 hover:text-slate-700" onclick="toggleSend(false)" aria-label="Close">✕</button>
      </div>
      <p class="text-sm text-slate-600 mt-2">We will open your email client prefilled with the details below. Edit as needed before sending.</p>
      <textarea id="sendBody" class="mt-4 w-full h-52 rounded-xl border border-slate-200 p-3 text-sm" spellcheck="false"></textarea>
      <div class="mt-4 flex items-center justify-end gap-3">
        <button class="px-4 py-2 rounded-xl border border-slate-200" onclick="toggleSend(false)">Cancel</button>
        <a id="mailtoLink" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white" href="#">Open Email</a>
      </div>
    </div>
  </div>

  <script>
    // --------- State ---------
    const state = {
      step: 0,
      steps: [
        { id: "customer", title: "Customer", subtitle: "Who is this for?" },
        { id: "devices", title: "Devices", subtitle: "Pick phones & qty" },
        { id: "plan", title: "Plan", subtitle: "Pick a plan" },
        { id: "trade", title: "Trade‑In", subtitle: "Device credits" },
        { id: "addons", title: "Add‑Ons", subtitle: "Insurance, extras" },
        { id: "review", title: "Review & Send", subtitle: "Breakdown & actions" },
      ],
      customer: { name: "", email: "", phone: "" },
      devices: [], // [{_id, manufacturer, model, unitPrice, qty}]
      plan: null,   // {carrier, name, price, speed, details}
      tradeIn: { hasTrade: false, estCredit: 0, notes: "" },
      addons: [],   // [{name, price}]
      prices: { subtotal: 0, tax: 0, credits: 0, total: 0 },
      catalog: { phones: [], plans: [] },
    };

    const currency = v => new Intl.NumberFormat(undefined, { style: 'currency', currency: 'CAD' }).format(v ?? 0);

    // --------- Helpers ---------
    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => [...el.querySelectorAll(s)];
    const el = (tag, cls, html) => { const n = document.createElement(tag); if(cls) n.className = cls; if(html!==undefined) n.innerHTML = html; return n; };

    const showToast = (msg="Saved!") => {
      const t = qs('#toast');
      t.textContent = msg;
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 1600);
    };

    const persistDraft = () => {
      localStorage.setItem('wmq_quote_draft', JSON.stringify(state));
      showToast('Draft saved');
    };

    const loadDraft = () => {
      const raw = localStorage.getItem('wmq_quote_draft');
      if(!raw) return false;
      try { const s = JSON.parse(raw); Object.assign(state, s); return true; } catch(e) { return false; }
    };

    // --------- Progress UI ---------
    function renderProgress(){
      const ol = qs('#progress');
      ol.innerHTML = '';
      state.steps.forEach((s, i) => {
        const active = i === state.step;
        const done = i < state.step;
        const li = el('li', `flex items-center gap-3 p-3 rounded-xl border ${active? 'border-emerald-200 bg-emerald-50' : 'border-slate-200 bg-white'} transition`);
        li.innerHTML = `
          <div class="flex items-center justify-center w-6 h-6 rounded-full text-xs font-semibold ${done? 'bg-emerald-600 text-white' : active? 'border-2 border-emerald-600 text-emerald-700' : 'border-2 border-slate-300 text-slate-500'}">${i+1}</div>
          <div>
            <div class="text-xs ${active? 'text-emerald-700' : 'text-slate-500'}">${s.subtitle}</div>
            <div class="text-sm font-medium">${s.title}</div>
          </div>`;
        ol.appendChild(li);
      });
    }

    // --------- Slides ---------
    function slideShell(title, subtitle, content){
      const wrap = el('div', 'slide space-y-4');
      wrap.innerHTML = `
        <div>
          <h2 class="text-xl font-semibold">${title}</h2>
          <p class="text-slate-500">${subtitle}</p>
        </div>
        <div class="mt-2">${content}</div>`;
      return wrap;
    }

    function renderCustomer(){
      return slideShell('Customer Details', 'Enter the recipient of the quote', `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="text-sm text-slate-600">Full Name</label>
            <input id="custName" class="mt-1 w-full rounded-xl border border-slate-200 p-3" placeholder="Jane Doe" value="${state.customer.name || ''}" />
          </div>
          <div>
            <label class="text-sm text-slate-600">Email</label>
            <input id="custEmail" type="email" class="mt-1 w-full rounded-xl border border-slate-200 p-3" placeholder="jane@example.com" value="${state.customer.email || ''}" />
          </div>
          <div>
            <label class="text-sm text-slate-600">Phone</label>
            <input id="custPhone" class="mt-1 w-full rounded-xl border border-slate-200 p-3" placeholder="(555) 123‑4567" value="${state.customer.phone || ''}" />
          </div>
        </div>`);
    }

    function phoneCard(p){
      const price = p.price?.deviceRetailPrice ?? 0;
      const id = `ph_${p._id || (p.manufacturer+p.model).replace(/\W/g,'')}`;
      return `
        <label for="${id}" class="select-card block rounded-2xl border border-slate-200 p-4 hover:border-emerald-300 cursor-pointer focus-within:outline focus-within:outline-2 focus-within:outline-emerald-500" role="radio" aria-checked="false">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-slate-500">${p.manufacturer}</div>
              <div class="text-base font-semibold">${p.model}</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">Retail</div>
              <div class="font-semibold">${currency(price)}</div>
            </div>
          </div>
          <div class="mt-3 flex items-center gap-3">
            <input id="${id}" data-id="${p._id || id}" data-manufacturer="${p.manufacturer}" data-model="${p.model}" data-price="${price}" type="checkbox" class="rounded border-slate-300" />
            <div class="flex items-center gap-2">
              <span class="text-sm text-slate-600">Qty</span>
              <input type="number" min="1" value="1" class="w-16 rounded-lg border border-slate-200 p-2 qty-input" />
            </div>
          </div>
        </label>`;
    }

    function renderDevices(){
      const cards = state.catalog.phones.map(phoneCard).join('');
      return slideShell('Devices', 'Pick the devices and quantities (from your catalog)', `
        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4">${cards || '<div class="text-slate-500">No phones found</div>'}</div>
      `);
    }

    function planCard(pl){
      return `
        <label class="select-card block rounded-2xl border border-slate-200 p-4 hover:border-emerald-300 cursor-pointer" role="radio" aria-checked="false">
          <div class="flex items-center justify-between gap-4">
            <div>
              <div class="text-xs text-slate-500">${pl.carrier} · ${pl.speed || ''}</div>
              <div class="font-semibold">${pl.name}</div>
              <div class="text-sm text-slate-600">${pl.data ? (pl.data+ ' GB') : ''} ${pl.details? '· '+pl.details: ''}</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">Monthly</div>
              <div class="font-semibold">${currency(pl.price)}</div>
              <input type="radio" name="planPick" class="mt-2" />
            </div>
          </div>
        </label>`;
    }

    function renderPlan(){
      const cards = state.catalog.plans.map(planCard).join('');
      return slideShell('Plan', 'Choose a carrier plan', `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${cards || '<div class="text-slate-500">No plans found</div>'}</div>
      `);
    }

    function renderTrade(){
      return slideShell('Trade‑In', 'Optional: capture expected credits', `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="flex items-center gap-3">
            <input id="hasTrade" type="checkbox" class="rounded border-slate-300" ${state.tradeIn.hasTrade? 'checked' : ''} />
            <label for="hasTrade" class="text-sm">Trade‑in devices</label>
          </div>
          <div>
            <label class="text-sm text-slate-600">Estimated Credit</label>
            <input id="tradeCredit" type="number" min="0" class="mt-1 w-full rounded-xl border border-slate-200 p-3" value="${state.tradeIn.estCredit || 0}" />
          </div>
          <div class="md:col-span-3">
            <label class="text-sm text-slate-600">Notes</label>
            <input id="tradeNotes" class="mt-1 w-full rounded-xl border border-slate-200 p-3" placeholder="e.g., iPhone 12 in good condition" value="${state.tradeIn.notes || ''}" />
          </div>
        </div>`);
    }

    function renderAddons(){
      const addOns = [
        { name: 'Device Protection', price: 15 },
        { name: 'Premium Voicemail', price: 8 },
        { name: 'International Long Distance Pack', price: 12 },
      ];
      const list = addOns.map((a,i)=>`
        <label class="flex items-center justify-between gap-3 rounded-2xl border border-slate-200 p-4 hover:border-emerald-300 cursor-pointer">
          <div>
            <div class="font-medium">${a.name}</div>
            <div class="text-sm text-slate-600">Monthly add‑on</div>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <div class="text-xs text-slate-500">Monthly</div>
              <div class="font-semibold">${currency(a.price)}</div>
            </div>
            <input type="checkbox" data-name="${a.name}" data-price="${a.price}" />
          </div>
        </label>`).join('');

      return slideShell('Add‑Ons', 'Optional: add extras', `
        <div class="grid grid-cols-1 gap-4">${list}</div>
      `);
    }

    function renderReview(){
      const devices = state.devices.map(d => `<tr><td class="py-2">${d.manufacturer} ${d.model} × ${d.qty}</td><td class="py-2 text-right">${currency(d.unitPrice * d.qty)}</td></tr>`).join('') || '<tr><td class="py-2 text-slate-500">No devices selected</td><td></td></tr>';
      const addons = state.addons.map(a => `<tr><td class="py-2">${a.name}</td><td class="py-2 text-right">${currency(a.price)}</td></tr>`).join('') || '';
      const plan = state.plan ? `<tr><td class="py-2">${state.plan.carrier} ${state.plan.name}</td><td class="py-2 text-right">${currency(state.plan.price)}</td></tr>` : '';
      const credits = state.tradeIn?.estCredit ? `<tr><td class="py-2">Trade‑In Credit</td><td class="py-2 text-right">‑${currency(state.tradeIn.estCredit)}</td></tr>` : '';

      // (Placeholder) simple calc: devices one‑time + monthly(plan+addons) – credits (treated one‑time)
      const deviceTotal = state.devices.reduce((s,d)=> s + d.unitPrice * d.qty, 0);
      const monthly = (state.plan?.price || 0) + state.addons.reduce((s,a)=> s + a.price, 0);
      const creditsVal = Number(state.tradeIn?.estCredit || 0);
      const subtotal = deviceTotal + monthly;
      const tax = +(subtotal * 0.05).toFixed(2); // GST 5% placeholder
      const total = Math.max(0, subtotal + tax - creditsVal);
      state.prices = { subtotal, tax, credits: creditsVal, total };

      // Update Summary pane
      updateSummary();

      return slideShell('Review, Save & Send', 'Confirm breakdown then save or email the customer', `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h3 class="mt-5 mb-1 font-semibold mb-2">Cost Breakdown</h3>
            <table class="w-full text-sm ml-2">
              <tbody>
                ${devices}
                ${plan}
                ${addons}
                ${credits}
                <tr><td class="py-2 font-medium">Subtotal</td><td class="py-2 text-right">${currency(subtotal)}</td></tr>
                <tr><td class="py-2">Tax (est.)</td><td class="py-2 text-right">${currency(tax)}</td></tr>
                <tr><td class="py-2 font-semibold">Total Due</td><td class="py-2 text-right font-semibold">${currency(total)}</td></tr>
              </tbody>
            </table>
          </div>
		  
          
        </div>
		<div class="mt-5">
            <h3 class="font-semibold mb-2 mt-5">Actions</h3>
            <div class="space-y-3">
              <button id="saveQuote" class="w-full px-4 py-3 rounded-xl bg-slate-900 text-white hover:bg-black">Save Quote</button>
              <button id="sendQuote" class="w-full px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white">Send to Customer</button>
            </div>
            <p class="text-xs text-slate-500 mt-3">Calculations are placeholders; integrate your real pricing logic later.</p>
          </div>
      `);
    }

    // --------- Render engine ---------
    function renderSlides(){
      const host = qs('#slides');
      host.innerHTML = '';
      const renders = [renderCustomer, renderDevices, renderPlan, renderTrade, renderAddons, renderReview];
      const view = renders[state.step]();
      view.classList.add('slide-enter');
      host.appendChild(view);
      requestAnimationFrame(()=>{
        view.classList.remove('slide-enter');
        view.classList.add('slide-enter-active');
      });

      // Attach listeners for current slide
      if(state.step === 0){
        ['custName','custEmail','custPhone'].forEach(id => {
          qs('#'+id).addEventListener('input', e => {
            const k = id === 'custName' ? 'name' : id === 'custEmail' ? 'email' : 'phone';
            state.customer[k] = e.target.value.trim();
            updateSummary();
          });
        });
      }

      if(state.step === 1){
        qsa('label.select-card').forEach(card => {
          const cb = card.querySelector('input[type="checkbox"]');
          const qtyEl = card.querySelector('.qty-input');
          const updateAria = () => card.setAttribute('aria-checked', cb.checked ? 'true' : 'false');
          cb.addEventListener('change', () => {
            updateAria();
            syncDevices();
          });
          qtyEl.addEventListener('change', () => syncDevices());
        });
      }

      if(state.step === 2){
        qsa('label.select-card').forEach((card, idx) => {
          const radio = card.querySelector('input[type="radio"]');
          const updateAria = () => qsa('label.select-card').forEach(c => c.setAttribute('aria-checked','false'));
          radio.addEventListener('change', () => {
            updateAria(); card.setAttribute('aria-checked','true');
            state.plan = state.catalog.plans[idx];
            updateSummary();
          });
        });
      }

      if(state.step === 3){
        qs('#hasTrade').addEventListener('change', e=>{ state.tradeIn.hasTrade = e.target.checked; updateSummary(); });
        qs('#tradeCredit').addEventListener('input', e=>{ state.tradeIn.estCredit = Number(e.target.value||0); updateSummary(); });
        qs('#tradeNotes').addEventListener('input', e=>{ state.tradeIn.notes = e.target.value; });
      }

      if(state.step === 4){
        qsa('input[type="checkbox"]').forEach(chk => {
          chk.addEventListener('change', () => {
            const name = chk.dataset.name; const price = Number(chk.dataset.price);
            if(chk.checked){ state.addons.push({ name, price }); }
            else { state.addons = state.addons.filter(a => !(a.name===name && a.price===price)); }
            updateSummary();
          });
        });
      }

      if(state.step === 5){
        qs('#saveQuote').addEventListener('click', onSaveQuote);
        qs('#sendQuote').addEventListener('click', onSendQuote);
      }

      renderProgress();
      updateNavButtons();
      updateSummary();
    }

    function syncDevices(){
      const picks = [];
      qsa('#slides input[type="checkbox"]').forEach(cb => {
        const qtyEl = cb.closest('label').querySelector('.qty-input');
        if(cb.checked){
          picks.push({
            _id: cb.dataset.id,
            manufacturer: cb.dataset.manufacturer,
            model: cb.dataset.model,
            unitPrice: Number(cb.dataset.price || 0),
            qty: Number(qtyEl.value || 1)
          })
        }
      });
      state.devices = picks;
      updateSummary();
    }

    // --------- Summary Panel ---------
    function updateSummary(){
      qs('#sum-customer').textContent = state.customer.name ? `${state.customer.name} · ${state.customer.email || 'no email'} · ${state.customer.phone || ''}` : '—';
      const list = qs('#sum-devices');
      list.innerHTML = '';
      if(state.devices.length === 0){ list.innerHTML = '<li class="text-slate-400">No devices selected</li>'; }
      else state.devices.forEach(d => list.appendChild(el('li', '', `${d.manufacturer} ${d.model} × ${d.qty}`)));
      qs('#sum-plan').textContent = state.plan ? `${state.plan.carrier} ${state.plan.name} (${currency(state.plan.price)}/mo)` : '—';
      qs('#sum-trade').textContent = state.tradeIn?.hasTrade ? `${currency(state.tradeIn.estCredit || 0)} credit` : '—';
      const alist = qs('#sum-addons');
      alist.innerHTML = '';
      if(state.addons.length === 0){ alist.innerHTML = '<li class="text-slate-400">No add-ons selected</li>'; }
      else state.addons.forEach(a => alist.appendChild(el('li','', `${a.name} (${currency(a.price)}/mo)`)));

      if(state.step === 5){
        qs('#sum-total').textContent = currency(state.prices.total);
        qs('#sum-breakdown').textContent = `Subtotal ${currency(state.prices.subtotal)} · Tax ${currency(state.prices.tax)} · Credits −${currency(state.prices.credits)}`;
      } else {
        qs('#sum-total').textContent = '—';
        qs('#sum-breakdown').textContent = 'Calculated on the Review step.';
      }
    }

    // --------- Navigation ---------
    function updateNavButtons(){
      const prev = qs('#prevBtn');
      const next = qs('#nextBtn');
      prev.disabled = state.step === 0;
      next.textContent = state.step === state.steps.length - 1 ? 'Finish' : 'Next ▶';
    }

    function go(dir){
      const next = state.step + dir;
      if(next < 0 || next > state.steps.length - 1) return;
      state.step = next;
      renderSlides();
    }

    // --------- Save & Send ---------
    function onSaveQuote(){
      // Minimal payload; wire up to your API later
      const payload = { ...state, createdAt: new Date().toISOString() };
      localStorage.setItem('wmq_quote_saved', JSON.stringify(payload));
      showToast('Quote saved');
    }

    function buildEmailBody(){
      const lines = [];
      lines.push(`Hi ${state.customer.name || 'there'},`);
      lines.push('');
      lines.push('Here\'s your quote:');
      lines.push('');
      state.devices.forEach(d=>lines.push(`• ${d.manufacturer} ${d.model} × ${d.qty} — ${currency(d.unitPrice * d.qty)}`));
      if(state.plan) lines.push(`• Plan: ${state.plan.carrier} ${state.plan.name} — ${currency(state.plan.price)}/mo`);
      state.addons.forEach(a=>lines.push(`• Add‑On: ${a.name} — ${currency(a.price)}/mo`));
      if(state.tradeIn?.estCredit) lines.push(`• Trade‑In Credit: −${currency(state.tradeIn.estCredit)}`);
      lines.push('');
      lines.push(`Subtotal: ${currency(state.prices.subtotal)}`);
      lines.push(`Tax (est.): ${currency(state.prices.tax)}`);
      lines.push(`Total Due: ${currency(state.prices.total)}`);
      lines.push('');
      lines.push('Let me know if you\'d like to tweak anything.');
      lines.push('');
      lines.push('— Your Sales Rep');
      return lines.join('\n');
    }

    function toggleSend(open){
      const modal = qs('#sendModal');
      if(open){
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        qs('#sendBody').value = buildEmailBody();
        const subject = encodeURIComponent('Your Mobile Quote');
        const body = encodeURIComponent(qs('#sendBody').value);
        const mailto = `mailto:${encodeURIComponent(state.customer.email || '')}?subject=${subject}&body=${body}`;
        qs('#mailtoLink').setAttribute('href', mailto);
      } else {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    }

    function onSendQuote(){ toggleSend(true); }

    // --------- Data Fetch (with graceful fallback) ---------
    async function loadCatalog(){
      // Phones
      try {
        const r = await fetch('/api/phones');
        if(!r.ok) throw new Error('HTTP '+r.status);
        const phones = await r.json();
        state.catalog.phones = Array.isArray(phones) ? phones : [];
      } catch(e){
        // Fallback sample
        state.catalog.phones = [
          { _id: 'p1', manufacturer: 'Apple', model: 'iPhone 15', price: { deviceRetailPrice: 999 } },
          { _id: 'p2', manufacturer: 'Samsung', model: 'Galaxy S24', price: { deviceRetailPrice: 899 } },
          { _id: 'p3', manufacturer: 'Google', model: 'Pixel 9', price: { deviceRetailPrice: 799 } },
        ];
      }

      // Plans
      try {
        const r = await fetch('/api/plans');
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json();
        // Normalize a short list of displayable plans from your schema
        const pickBell = [...(data?.BYOD?.BellConsumer ? Array.from(data.BYOD.BellConsumer.values()) : [])].slice(0,2).map((p,idx)=>({ carrier: 'Bell', name: 'P'+(idx+1), price: (p.price?.[0]||0), speed: p.speed, data: p.data, details: (p.canUsCallingText?'CA/US calling · ':'')+(p.usRoam?'US roam':'') }));
        const pickVirgin = [...(data?.BYOD?.Virgin ? Array.from(data.BYOD.Virgin.values()) : [])].slice(0,2).map((p,idx)=>({ carrier: 'Virgin', name: 'V'+(idx+1), price: (p.price?.[0]||0), speed: p.speed, data: p.data, details: (p.internationalMinutes1000?'1000 intl mins · ':'')+(p.caUsCallingText?'CA/US calling':'') }));
        state.catalog.plans = [...pickBell, ...pickVirgin];
      } catch(e){
        state.catalog.plans = [
          { carrier: 'Bell', name: '5G+ 100GB', price: 65, speed: '5G+', data: 100, details: 'CA/US calling' },
          { carrier: 'Bell', name: '5G 50GB', price: 55, speed: '5G', data: 50, details: '1000 intl mins' },
          { carrier: 'Virgin', name: '4G 30GB', price: 40, speed: '4G', data: 30, details: '—' },
          { carrier: 'Virgin', name: '5G 60GB', price: 50, speed: '5G', data: 60, details: '—' },
        ];
      }
    }

    // --------- Init ---------
    async function init(){
      // Controls
      qs('#prevBtn').addEventListener('click', ()=>go(-1));
      qs('#nextBtn').addEventListener('click', ()=>{
        if(state.step < state.steps.length - 1) go(1); else showToast('All done');
      });
      qs('#saveDraft').addEventListener('click', persistDraft);
      qs('#resetForm').addEventListener('click', ()=>{ localStorage.removeItem('wmq_quote_draft'); location.reload(); });
      qs('#loadDraft').addEventListener('click', ()=>{ if(loadDraft()) { renderSlides(); showToast('Draft loaded'); } else showToast('No draft found'); });

      // Prefill from draft (if any)
      loadDraft();

      // Catalog
      await loadCatalog();

      // First render
      renderSlides();
    }

    window.addEventListener('keydown', (e)=>{
      if(e.key === 'ArrowRight') go(1);
      if(e.key === 'ArrowLeft') go(-1);
    });

    init();
  </script>
</body>
</html>
