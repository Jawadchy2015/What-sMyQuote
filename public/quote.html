<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>New User Intake — Quote Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .card { @apply bg-white rounded-2xl border border-slate-200 shadow-sm; }
    .label { @apply text-sm font-medium text-slate-700; }
    .input { @apply w-full mt-1 rounded-xl border border-slate-300 p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500; }
    .hint { @apply text-xs text-slate-500; }
    .section-title { @apply text-sm font-semibold text-slate-800 uppercase tracking-wide; }
    .pill { @apply inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ring-1 ring-slate-200 text-slate-600; }
    .btn { @apply px-4 py-2 rounded-xl transition; }
    .btn-primary { @apply bg-indigo-600 hover:bg-indigo-700 text-white shadow; }
    .btn-ghost { @apply bg-white border border-slate-200 hover:bg-slate-50 text-slate-700; }
    .btn-alt { @apply bg-emerald-600 hover:bg-emerald-700 text-white shadow; }
    .modal-backdrop { @apply fixed inset-0 bg-black/50 flex items-center justify-center z-50; }
    .modal { @apply w-full max-w-lg card p-6; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <div class="mx-auto max-w-7xl px-4 md:px-6 lg:px-8 py-10">
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-3xl font-semibold text-slate-900">New User Form</h1>
        <p class="text-slate-500">Fill out the intake form — live preview updates as you type.</p>
      </div>
      <div class="flex items-center gap-3">
        <button id="btnReset" class="btn btn-ghost">Reset</button>
        <button id="btnSubmit" class="btn btn-primary">Submit</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Form -->
      <form id="newUserForm" class="space-y-6 card p-6" onsubmit="return false;">
        <!-- PHONE SECTION -->
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <h2 class="section-title">Phone Section</h2>
            <span class="pill">Step 1</span>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="label">Current Provider</label>
              <select id="currProvider" class="input">
                <option value="">Select…</option>
                <option>Rogers</option>
                <option>Fido</option>
                <option>Chatr</option>
                <option>Telus</option>
                <option>Koodo</option>
                <option>Public</option>
                <option>Others</option>
              </select>
              <p class="hint">If "Others" is selected, specify below.</p>
            </div>
            <div id="providerOtherWrap" class="hidden">
              <label class="label">Other Provider</label>
              <input id="providerOther" class="input" placeholder="Enter provider name" />
            </div>

            <div>
              <label class="label">Number of Lines</label>
              <input id="numLines" type="number" class="input" placeholder="e.g., 3" />
            </div>

            <div class="flex items-center gap-3 mt-6">
              <input id="smb" type="checkbox" class="h-5 w-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
              <label for="smb" class="label">SMB</label>
            </div>

            <div>
              <label class="label">Number of Phones</label>
              <input id="numPhones" type="number" class="input" placeholder="e.g., 2" />
            </div>

            <div>
              <label class="label">Phone Choice <span class="text-slate-400">(from catalog)</span></label>
              <select id="phoneChoice" class="input" multiple size="5"></select>
              <p class="hint">Hold Ctrl/Cmd to select multiple. Loaded from <code>/api/phones</code>.</p>
            </div>
          </div>
        </div>

        <hr class="border-slate-200" />

        <!-- PLAN SECTION -->
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <h2 class="section-title">Plan Section</h2>
            <span class="pill">Step 2</span>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="flex items-center gap-3"><input id="plan5g" type="checkbox" class="h-5 w-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"><span class="label">5G</span></label>
            <label class="flex items-center gap-3"><input id="planZeroOveruse" type="checkbox" class="h-5 w-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"><span class="label">$0 Data Overuse</span></label>
            <label class="flex items-center gap-3"><input id="planMin1000" type="checkbox" class="h-5 w-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"><span class="label">1000 min</span></label>
            <label class="flex items-center gap-3"><input id="planMin200" type="checkbox" class="h-5 w-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"><span class="label">200 min</span></label>
            <label class="flex items-center gap-3"><input id="planUsRoam" type="checkbox" class="h-5 w-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"><span class="label">US Roam</span></label>
            <label class="flex items-center gap-3"><input id="planCaUsCalling" type="checkbox" class="h-5 w-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"><span class="label">CA/US Calling</span></label>
            <label class="flex items-center gap-3"><input id="planUsMxRoam" type="checkbox" class="h-5 w-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"><span class="label">US/MX Roam</span></label>
          </div>
        </div>

        <hr class="border-slate-200" />

        <!-- ADD-ON SECTION -->
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <h2 class="section-title">Add-On Section</h2>
            <span class="pill">Step 3</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="label">Num of SPC</label><input id="addonSpc" type="number" class="input" /></div>
            <div><label class="label">DF / Line</label><input id="addonDfPerLine" type="number" class="input" /></div>
            <div><label class="label"># of CC Waiver</label><input id="addonCcWaiver" type="number" class="input" /></div>
            <div><label class="label">Trade-In</label><input id="addonTradeIn" type="number" class="input" /></div>
            <div><label class="label">Upfront / Line</label><input id="addonUpfrontPerLine" type="number" class="input" /></div>
          </div>
        </div>
      </form>

      <!-- Preview + Actions -->
      <div class="space-y-6">
        <div class="card p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">Live Preview</h2>
            <span class="pill">Overview</span>
          </div>
          <div class="space-y-4 text-slate-700">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="p-4 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500 mb-1">Provider</div><div id="pvProvider" class="font-medium">—</div></div>
              <div class="p-4 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500 mb-1">Lines</div><div id="pvLines" class="font-medium">—</div></div>
              <div class="p-4 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500 mb-1">SMB</div><div id="pvSmb" class="font-medium">—</div></div>
              <div class="p-4 rounded-xl bg-slate-50 border border-slate-200"><div class="text-xs text-slate-500 mb-1">Phones</div><div id="pvPhones" class="font-medium">—</div></div>
            </div>
            <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
              <div class="text-sm font-medium text-slate-800 mb-2">Plan Flags</div>
              <ul id="pvPlanFlags" class="list-disc list-inside text-slate-600 text-sm space-y-1"></ul>
            </div>
            <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
              <div class="text-sm font-medium text-slate-800 mb-2">Add-ons</div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-slate-600">
                <div><span class="text-slate-500">SPC:</span> <span id="pvSpc">0</span></div>
                <div><span class="text-slate-500">DF/Line:</span> <span id="pvDfPerLine">0</span></div>
                <div><span class="text-slate-500">CC Waiver:</span> <span id="pvCcWaiver">0</span></div>
                <div><span class="text-slate-500">Trade-In:</span> <span id="pvTradeIn">0</span></div>
                <div><span class="text-slate-500">Upfront/Line:</span> <span id="pvUpfrontPerLine">0</span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions Card -->
        <div class="card p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">Actions</h2>
            <span class="pill">Next Steps</span>
          </div>
          <p class="text-sm text-slate-500 mb-4">Choose what to do with this configuration. These actions submit the same data shown above.</p>
          <div class="flex flex-wrap gap-3">
            <button id="btnSaveQuote" class="btn btn-primary">Save Quote</button>
            <button id="btnSendQuote" class="btn btn-alt">Send Quote to Customer</button>
          </div>
          <p class="text-xs text-slate-400 mt-3">Note: API endpoints and email sending are placeholders to be implemented on the backend.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Email Modal -->
    <div id="emailModal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/40 p-4">
    <div class="bg-white w-full max-w-lg rounded-2xl shadow-soft p-6">
      <div class="flex items-start justify-between">
        <h3 class="text-lg font-semibold">Send Quote to Customer</h3>
        <button class="p-2 -m-2 text-slate-500 hover:text-slate-700" onclick="toggleSend(false)" aria-label="Close">✕</button>
      </div>
      <p class="text-sm text-slate-600 mt-2">We will open your email client prefilled with the details below. Edit as needed before sending.</p>
      <textarea id="sendBody" class="mt-4 w-full h-52 rounded-xl border border-slate-200 p-3 text-sm" spellcheck="false"></textarea>
      <div class="mt-4 flex items-center justify-end gap-3">
        <button id="emailClose"class="px-4 py-2 rounded-xl border border-slate-200" onclick="toggleSend(false)">Cancel</button>
        <a id="mailtoLink" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white" href="#">Open Email</a>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm shadow-lg">Saved</div>

  <script>
    // --- State ---
    const state = {
      phoneSection: { currProvider: '', providerOther: '', numLines: null, smb: false, numPhones: null, phoneChoice: [] },
      planSection: { fiveG: false, zeroOveruse: false, min1000: false, min200: false, usRoam: false, caUsCalling: false, usMxRoam: false },
      addOnSection: { spc: 0, dfPerLine: 0, ccWaiver: 0, tradeIn: 0, upfrontPerLine: 0 },
      phonesCatalog: []
    };

    const el = id => document.getElementById(id);

    // --- Fetch phones for selection ---
    async function loadPhones() {
      try {
        const res = await fetch('/api/phones');
        const data = await res.json();
        state.phonesCatalog = Array.isArray(data) ? data : (data?.phones || []);

        const select = el('phoneChoice');
        select.innerHTML = '';
        state.phonesCatalog.forEach(p => {
          const label = [p.manufacturer, p.model, p.storage?.[0] ? '(' + p.storage[0] + ')' : '']
            .filter(Boolean).join(' ');
          const opt = document.createElement('option');
          opt.value = p._id || p.id || label;
          opt.textContent = label;
          select.appendChild(opt);
        });
      } catch (e) {
        console.error('Failed to load phones', e);
      }
    }

    // --- Bind inputs to state ---
    function bind() {
      // Provider & details
      el('currProvider').addEventListener('change', e => {
        state.phoneSection.currProvider = e.target.value;
        el('providerOtherWrap').classList.toggle('hidden', e.target.value !== 'Others');
        update();
      });
      el('providerOther').addEventListener('input', e => { state.phoneSection.providerOther = e.target.value; update(); });

      // Numbers & toggles
      el('numLines').addEventListener('input', e => { state.phoneSection.numLines = asInt(e.target.value); update(); });
      el('smb').addEventListener('change', e => { state.phoneSection.smb = !!e.target.checked; update(); });
      el('numPhones').addEventListener('input', e => { state.phoneSection.numPhones = asInt(e.target.value); update(); });

      // Phone multi-select
      el('phoneChoice').addEventListener('change', e => {
        const values = Array.from(e.target.selectedOptions).map(o => o.value);
        state.phoneSection.phoneChoice = values;
        update();
      });

      // Plan checkboxes
      el('plan5g').addEventListener('change', e => { state.planSection.fiveG = e.target.checked; update(); });
      el('planZeroOveruse').addEventListener('change', e => { state.planSection.zeroOveruse = e.target.checked; update(); });
      el('planMin1000').addEventListener('change', e => { state.planSection.min1000 = e.target.checked; update(); });
      el('planMin200').addEventListener('change', e => { state.planSection.min200 = e.target.checked; update(); });
      el('planUsRoam').addEventListener('change', e => { state.planSection.usRoam = e.target.checked; update(); });
      el('planCaUsCalling').addEventListener('change', e => { state.planSection.caUsCalling = e.target.checked; update(); });
      el('planUsMxRoam').addEventListener('change', e => { state.planSection.usMxRoam = e.target.checked; update(); });

      // Add-on numbers
      el('addonSpc').addEventListener('input', e => { state.addOnSection.spc = asInt(e.target.value); update(); });
      el('addonDfPerLine').addEventListener('input', e => { state.addOnSection.dfPerLine = asInt(e.target.value); update(); });
      el('addonCcWaiver').addEventListener('input', e => { state.addOnSection.ccWaiver = asInt(e.target.value); update(); });
      el('addonTradeIn').addEventListener('input', e => { state.addOnSection.tradeIn = asInt(e.target.value); update(); });
      el('addonUpfrontPerLine').addEventListener('input', e => { state.addOnSection.upfrontPerLine = asInt(e.target.value); update(); });

      // Global actions
      el('btnSubmit').addEventListener('click', submitForm);
      el('btnReset').addEventListener('click', () => { resetForm(); showToast('Reset'); });

      // Actions card
      el('btnSaveQuote').addEventListener('click', saveQuote);
      el('btnSendQuote').addEventListener('click', openEmailModal);

      // Modal actions
      el('emailClose').addEventListener('click', closeEmailModal);
      el('emailSend').addEventListener('click', sendQuoteEmail);
    }

    function asInt(v) { const n = parseInt(v, 10); return Number.isFinite(n) ? n : 0; }

    // --- Render preview ---
    function update() {
      const p = state.phoneSection;

      const provider = p.currProvider === 'Others' && p.providerOther
        ? `${p.currProvider} — ${p.providerOther}`
        : (p.currProvider || '—');
      el('pvProvider').textContent = provider;
      el('pvLines').textContent = p.numLines || '—';
      el('pvSmb').textContent = p.smb ? 'Yes' : 'No';

      const phoneLabels = p.phoneChoice
        .map(id => state.phonesCatalog.find(x => (x._id || x.id) == id))
        .filter(Boolean)
        .map(x => [x.manufacturer, x.model, x.storage?.[0] ? '(' + x.storage[0] + ')' : '']
          .filter(Boolean).join(' '));
      el('pvPhones').textContent = phoneLabels.length ? `${phoneLabels.length} selected` : '—';

      const flags = [];
      const pl = state.planSection;
      if (pl.fiveG) flags.push('5G');
      if (pl.zeroOveruse) flags.push('$0 Data Overuse');
      if (pl.min1000) flags.push('1000 min');
      if (pl.min200) flags.push('200 min');
      if (pl.usRoam) flags.push('US Roam');
      if (pl.caUsCalling) flags.push('CA/US Calling');
      if (pl.usMxRoam) flags.push('US/MX Roam');
      el('pvPlanFlags').innerHTML = flags.length ? flags.map(f => `<li>${f}</li>`).join('') : '<li>—</li>';

      // Pre-fill email modal fields with a simple summary
      const email = buildEmailFromPayload();
      el('emailSubject').value = email.subject;
      el('emailBody').value = email.body;
    }

    function buildPayload() {
      return {
        phoneSection: { ...state.phoneSection },
        planSection: { ...state.planSection },
        addOnSection: { ...state.addOnSection },
        meta: { createdAt: new Date().toISOString() }
      };
    }

    // Submit button (generic demo endpoint)
    async function submitForm() {
      const payload = buildPayload();
      try {
        const res = await fetch('/api/new-user-form', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Request failed');
        showToast('Submitted');
      } catch (e) { console.error(e); showToast('Submit failed'); }
    }

    // Save Quote (placeholder backend endpoint)
    async function saveQuote() {
      const payload = buildPayload();
      try {
        const res = await fetch('/api/quotes', { // TODO: implement on backend with Save Quote schema
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Save failed');
        showToast('Quote saved');
      } catch (e) { console.error(e); showToast('Save failed'); }
    }

    // Email modal
    function openEmailModal() { el('emailModal').classList.remove('hidden'); }
    function closeEmailModal() { el('emailModal').classList.add('hidden'); }

    function buildEmailFromPayload() {
      const p = buildPayload();
      const subject = 'Your Quote';
      const lines = [
        'Hi,',
        '',
        'Please find your quote details below:',
        '',
        `Provider: ${p.phoneSection.currProvider}${p.phoneSection.providerOther ? ' ('+p.phoneSection.providerOther+')' : ''}`,
        `Lines: ${p.phoneSection.numLines ?? 0}`,
        `SMB: ${p.phoneSection.smb ? 'Yes' : 'No'}`,
        `Phones Selected: ${p.phoneSection.phoneChoice.length}`,
        '',
        'Plan Flags:',
        `  5G: ${p.planSection.fiveG ? 'Yes' : 'No'}`,
        `  $0 Data Overuse: ${p.planSection.zeroOveruse ? 'Yes' : 'No'}`,
        `  1000 min: ${p.planSection.min1000 ? 'Yes' : 'No'}`,
        `  200 min: ${p.planSection.min200 ? 'Yes' : 'No'}`,
        `  US Roam: ${p.planSection.usRoam ? 'Yes' : 'No'}`,
        `  CA/US Calling: ${p.planSection.caUsCalling ? 'Yes' : 'No'}`,
        `  US/MX Roam: ${p.planSection.usMxRoam ? 'Yes' : 'No'}`,
        '',
        'Add-ons:',
        `  SPC: ${p.addOnSection.spc}`,
        `  DF/Line: ${p.addOnSection.dfPerLine}`,
        `  CC Waiver: ${p.addOnSection.ccWaiver}`,
        `  Trade-In: ${p.addOnSection.tradeIn}`,
        `  Upfront/Line: ${p.addOnSection.upfrontPerLine}`,
        '',
        '—',
        'Thank you!'
      ];
      return { subject, body: lines.join('') };
    }

    function encodeMailto(obj) {
      const params = new URLSearchParams({ subject: obj.subject, body: obj.body });
      return `mailto:${encodeURIComponent(el('emailTo').value || '')}?${params.toString()}`;
    }

    function sendQuoteEmail() {
      const email = { subject: el('emailSubject').value, body: el('emailBody').value };
      const url = encodeMailto(email);
      window.location.href = url; // temporary implementation
      closeEmailModal();
      showToast('Opening email');
    }

    function resetForm() {
      state.phoneSection = { currProvider: '', providerOther: '', numLines: null, smb: false, numPhones: null, phoneChoice: [] };
      state.planSection  = { fiveG: false, zeroOveruse: false, min1000: false, min200: false, usRoam: false, caUsCalling: false, usMxRoam: false };
      state.addOnSection = { spc: 0, dfPerLine: 0, ccWaiver: 0, tradeIn: 0, upfrontPerLine: 0 };

      el('newUserForm').reset();
      Array.from(el('phoneChoice').options).forEach(o => (o.selected = false));
      el('providerOtherWrap').classList.add('hidden');

      update();
    }

    function showToast(msg = 'Saved') {
      const t = el('toast');
      t.textContent = msg;
      t.classList.remove('hidden');
      clearTimeout(t._tid);
      t._tid = setTimeout(() => t.classList.add('hidden'), 1600);
    }

    // Init
    loadPhones().then(() => { bind(); update(); });
  </script>
</body>
</html>
